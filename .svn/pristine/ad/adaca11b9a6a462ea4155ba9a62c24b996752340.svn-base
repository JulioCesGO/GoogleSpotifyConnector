package br.com.julioces.api.oauth.spotify;

import java.io.IOException;
import java.io.InputStream;
import java.io.StringWriter;

import java.util.HashMap;

import java.util.Map;

import org.apache.http.HttpEntity;
import org.apache.http.HttpResponse;
import org.apache.http.client.methods.HttpGet;
import org.apache.http.client.methods.HttpPut;
import org.apache.http.entity.StringEntity;
import org.apache.http.impl.client.CloseableHttpClient;
import org.apache.http.impl.client.HttpClients;
import org.codehaus.jackson.JsonNode;
import org.codehaus.jackson.map.DeserializationConfig.Feature;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;
import org.codehaus.jackson.map.ObjectMapper;
import org.springframework.stereotype.Service;

import br.com.julioces.api.Spotify;
import br.com.julioces.api.oauth.google.WebApiUtil;
import br.com.julioces.api.oauth.spotify.model.CurrentPlayingTrack;
import br.com.julioces.api.oauth.spotify.model.CurrentUsersSavedTracks;
import br.com.julioces.api.oauth.spotify.model.SpotifyErro;

/*
 * Classe que representa acesso a serviços do Spotify
 */
@Service
public class SpotifyWEBAPI extends WebApiUtil implements ISpotifyWEBAPI{
	
	private static Logger logger = LoggerFactory.getLogger(SpotifyWEBAPI.class);
	private static String AUTOTIZACAO = "Authorization";

	/*
	 * Funcao que busca as ultimas musicas salvas na Conta do usuario.
	 * @see br.com.julioces.api.oauth.spotify.ISpotifyWEBAPI#getCurrentUsersSavedTrack(br.com.julioces.api.Spotify, java.lang.String)
	 */
	@Override
	public Map<String,Object>  getCurrentUsersSavedTrack(Spotify spotify, String urlnext) {
		CurrentUsersSavedTracks currentTracks = null; 
		SpotifyErro spotifyErro = null;
		Map<String,Object> mapretorno = new HashMap<String, Object>();
		CloseableHttpClient httpClient= null;
		try {
			
			String url = null;
			if (urlnext!=null && !urlnext.isEmpty())
				url = urlnext;
			else
				url ="https://api.spotify.com/v1/me/tracks";
			httpClient = HttpClients.createDefault();
			HttpGet httpGet = new HttpGet(url);
			httpGet.addHeader(AUTOTIZACAO, "Bearer  " + spotify.getAccess_token() );
			
			HttpResponse response = httpClient.execute(httpGet);
			HttpEntity entity = response.getEntity();
			
			if (entity != null)
			{
				InputStream instream = entity.getContent();
				ProcessarListadeMusicas(currentTracks, spotifyErro, mapretorno, instream);
			}		
			
		
		} catch (IllegalStateException e1) {
			logger.error(e1.getMessage());
		} catch (IOException e1) {
			logger.error(e1.getMessage());
		} finally {
			FecharConexaoHttpClient(httpClient);
		}
				
		return mapretorno;
	}

	private void ProcessarListadeMusicas(CurrentUsersSavedTracks currentTracks, SpotifyErro spotifyErro,
			Map<String, Object> mapretorno, InputStream instream) throws IOException {
		String retorno;
		try
		{
			StringWriter writer = new StringWriter();
			org.apache.commons.io.IOUtils.copy(instream, writer);
			retorno = writer.toString();
			
			JsonNode node = new ObjectMapper().readTree(retorno);
			ObjectMapper mapper = new ObjectMapper();
			if (node.get("error")!= null )
			{
				mapper.configure(Feature.UNWRAP_ROOT_VALUE, false);
				spotifyErro = mapper.readValue(retorno, SpotifyErro.class);						
			}
			else
			{						
				mapper.configure(Feature.FAIL_ON_UNKNOWN_PROPERTIES, false);
				currentTracks = mapper.readValue(retorno, CurrentUsersSavedTracks.class);
			}
			mapretorno.put("currentListTrack", currentTracks);
			mapretorno.put("error", spotifyErro);
		} catch (IOException e) {
			logger.error(e.getMessage());
		}
		finally {
			instream.close();
		}
	}

	@Override
	public Map<String,Object>  getCurrentPlayingTrack(Spotify spotify) {
		String retorno= null;
		CurrentPlayingTrack currentPlayingTrack = null;
		SpotifyErro spotifyErro = null;
		Map<String,Object> mapretorno = new HashMap<String, Object>();
		CloseableHttpClient httpClient = null;
		try {
			String url = null;
			
				url ="https://api.spotify.com/v1/me/player/currently-playing";
			httpClient = HttpClients.createDefault();
			HttpGet httpGet = new HttpGet(url);
			httpGet.addHeader(AUTOTIZACAO, "Bearer  " + spotify.getAccess_token() );
			
			HttpResponse response = httpClient.execute(httpGet);
			HttpEntity entity = response.getEntity();
			
			if (entity != null)
			{
				InputStream instream = entity.getContent();
				try
				{
					StringWriter writer = new StringWriter();
					org.apache.commons.io.IOUtils.copy(instream, writer);
					retorno = writer.toString();
					ObjectMapper mapper = new ObjectMapper();
					
					JsonNode node = new ObjectMapper().readTree(retorno);
					if (node.get("error")!= null )
					{
						mapper.configure(Feature.UNWRAP_ROOT_VALUE, false);
						spotifyErro = mapper.readValue(retorno, SpotifyErro.class);
						
					}
					else
					{
						mapper.configure(Feature.FAIL_ON_UNKNOWN_PROPERTIES, false);
						currentPlayingTrack = mapper.readValue(retorno, CurrentPlayingTrack.class);
					}
					mapretorno.put("error", spotifyErro);
					mapretorno.put("currentPlayingTrack", currentPlayingTrack);
					
				} catch (IOException e) {
					logger.error("Erro ao Converter retorno" + e.getMessage());
				}
				finally {
					instream.close();
				}
			}		
			
		
		} catch (IllegalStateException e1) {
			logger.error(e1.getLocalizedMessage());
		} catch (IOException e1) {
			logger.error(e1.getMessage());
		} finally {
			FecharConexaoHttpClient(httpClient);
		}
				
		return mapretorno;
	}

	/*
	 * Função responsavel por reproduzir 'Track' no dispositivo atual - Endereco: https://api.spotify.com/v1/me/player/play
	 * 
	 * @see br.com.julioces.api.oauth.spotify.ISpotifyWEBAPI#putPlay(br.com.julioces.api.Spotify, java.lang.String)
	 */
	@Override
	public Map<String, Object> putPlay(Spotify spotify, String uri) {
		
		Map<String,Object> mapretorno = new HashMap<String, Object>();
		CloseableHttpClient httpClient = null;
		try {
			String url = "https://api.spotify.com/v1/me/player/play";
						
			httpClient = HttpClients.createDefault();
			HttpPut httpPut = new HttpPut(url);
			httpPut.addHeader("Authorization", "Bearer  " + spotify.getAccess_token() );
			
			if (uri!= null && uri.length()>0)
				httpPut.setEntity(new StringEntity("{\"uris\": [\""+ uri + "\"]}"));
			
			HttpResponse response = httpClient.execute(httpPut);
			mapretorno.put("status", response.getStatusLine());
			logger.info(response.getStatusLine().toString());
			
		
		} catch (Exception e1) {
			mapretorno.put("error", e1.getMessage());
		} finally {
			FecharConexaoHttpClient(httpClient);
		}
				
		return mapretorno;
	}

}
